{"version":3,"sources":["@wordpress/block-editor/src/components/block-list/insertion-point.js"],"names":["InsertionPointInserter","clientId","setIsInserterForced","containerRef","ref","isInserterHidden","select","getMultiSelectedBlockClientIds","getSelectedBlockClientId","hasMultiSelection","multiSelectedBlockClientIds","selectedBlockClientId","includes","focusClosestTabbable","event","clientX","clientY","target","current","targetRect","getBoundingClientRect","isReverse","top","height","blockNode","container","closest","rect","window","DOMRect","InsertionPointPopover","isInserterShown","isInserterForced","showInsertionPoint","element","width","offsetWidth","InsertionPoint","children","setIsInserterShown","inserterClientId","setInserterClientId","_isMultiSelecting","isMultiSelecting","isBlockInsertionPointVisible","getBlockInsertionPoint","getBlockOrder","insertionPoint","order","rootClientId","isInserterVisible","selectedClientId","index","onMouseMove","classList","contains","offset","Array","from","find","blockEl","offsetTop","id","slice","length","elementRect","right","left","isVisible","undefined"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport classnames from 'classnames';\n\n/**\n * WordPress dependencies\n */\nimport { useSelect } from '@wordpress/data';\nimport { useState, useRef } from '@wordpress/element';\nimport { Popover } from '@wordpress/components';\nimport { placeCaretAtVerticalEdge } from '@wordpress/dom';\n\n/**\n * Internal dependencies\n */\nimport Inserter from '../inserter';\nimport { getClosestTabbable } from '../writing-flow';\nimport { getBlockDOMNode } from '../../utils/dom';\n\nfunction InsertionPointInserter( {\n\tclientId,\n\tsetIsInserterForced,\n\tcontainerRef,\n} ) {\n\tconst ref = useRef();\n\t// Hide the inserter above the selected block and during multi-selection.\n\tconst isInserterHidden = useSelect(\n\t\t( select ) => {\n\t\t\tconst {\n\t\t\t\tgetMultiSelectedBlockClientIds,\n\t\t\t\tgetSelectedBlockClientId,\n\t\t\t\thasMultiSelection,\n\t\t\t} = select( 'core/block-editor' );\n\t\t\tconst multiSelectedBlockClientIds = getMultiSelectedBlockClientIds();\n\t\t\tconst selectedBlockClientId = getSelectedBlockClientId();\n\n\t\t\treturn hasMultiSelection()\n\t\t\t\t? multiSelectedBlockClientIds.includes( clientId )\n\t\t\t\t: clientId === selectedBlockClientId;\n\t\t},\n\t\t[ clientId ]\n\t);\n\n\tfunction focusClosestTabbable( event ) {\n\t\tconst { clientX, clientY, target } = event;\n\n\t\t// Only handle click on the wrapper specifically, and not an event\n\t\t// bubbled from the inserter itself.\n\t\tif ( target !== ref.current ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst targetRect = target.getBoundingClientRect();\n\t\tconst isReverse = clientY < targetRect.top + targetRect.height / 2;\n\t\tconst blockNode = getBlockDOMNode( clientId );\n\t\tconst container = isReverse ? containerRef.current : blockNode;\n\t\tconst closest =\n\t\t\tgetClosestTabbable( blockNode, true, container ) || blockNode;\n\t\tconst rect = new window.DOMRect( clientX, clientY, 0, 16 );\n\n\t\tplaceCaretAtVerticalEdge( closest, isReverse, rect, false );\n\t}\n\n\treturn (\n\t\t/* eslint-disable-next-line jsx-a11y/no-static-element-interactions, jsx-a11y/click-events-have-key-events */\n\t\t<div\n\t\t\tref={ ref }\n\t\t\tonFocus={ () => setIsInserterForced( true ) }\n\t\t\tonBlur={ () => setIsInserterForced( false ) }\n\t\t\tonClick={ focusClosestTabbable }\n\t\t\t// While ideally it would be enough to capture the\n\t\t\t// bubbling focus event from the Inserter, due to the\n\t\t\t// characteristics of click focusing of `button`s in\n\t\t\t// Firefox and Safari, it is not reliable.\n\t\t\t//\n\t\t\t// See: https://developer.mozilla.org/en-US/docs/Web/HTML/Element/button#Clicking_and_focus\n\t\t\ttabIndex={ -1 }\n\t\t\tclassName={ classnames(\n\t\t\t\t'block-editor-block-list__insertion-point-inserter',\n\t\t\t\t{\n\t\t\t\t\t'is-inserter-hidden': isInserterHidden,\n\t\t\t\t}\n\t\t\t) }\n\t\t>\n\t\t\t<Inserter\n\t\t\t\tposition=\"bottom center\"\n\t\t\t\tclientId={ clientId }\n\t\t\t\t__experimentalIsQuick\n\t\t\t/>\n\t\t</div>\n\t);\n}\n\nfunction InsertionPointPopover( {\n\tclientId,\n\tisInserterShown,\n\tisInserterForced,\n\tsetIsInserterForced,\n\tcontainerRef,\n\tshowInsertionPoint,\n} ) {\n\tconst element = getBlockDOMNode( clientId );\n\n\treturn (\n\t\t<Popover\n\t\t\tnoArrow\n\t\t\tanimate={ false }\n\t\t\tanchorRef={ element }\n\t\t\tposition=\"top right left\"\n\t\t\tfocusOnMount={ false }\n\t\t\tclassName=\"block-editor-block-list__insertion-point-popover\"\n\t\t\t__unstableSlotName=\"block-toolbar\"\n\t\t>\n\t\t\t<div\n\t\t\t\tclassName=\"block-editor-block-list__insertion-point\"\n\t\t\t\tstyle={ { width: element?.offsetWidth } }\n\t\t\t>\n\t\t\t\t{ showInsertionPoint && (\n\t\t\t\t\t<div className=\"block-editor-block-list__insertion-point-indicator\" />\n\t\t\t\t) }\n\t\t\t\t{ ( isInserterShown || isInserterForced ) && (\n\t\t\t\t\t<InsertionPointInserter\n\t\t\t\t\t\tclientId={ clientId }\n\t\t\t\t\t\tsetIsInserterForced={ setIsInserterForced }\n\t\t\t\t\t\tcontainerRef={ containerRef }\n\t\t\t\t\t/>\n\t\t\t\t) }\n\t\t\t</div>\n\t\t</Popover>\n\t);\n}\n\nexport default function InsertionPoint( { children, containerRef } ) {\n\tconst [ isInserterShown, setIsInserterShown ] = useState( false );\n\tconst [ isInserterForced, setIsInserterForced ] = useState( false );\n\tconst [ inserterClientId, setInserterClientId ] = useState( null );\n\tconst { isMultiSelecting, isInserterVisible, selectedClientId } = useSelect(\n\t\t( select ) => {\n\t\t\tconst {\n\t\t\t\tisMultiSelecting: _isMultiSelecting,\n\t\t\t\tisBlockInsertionPointVisible,\n\t\t\t\tgetBlockInsertionPoint,\n\t\t\t\tgetBlockOrder,\n\t\t\t} = select( 'core/block-editor' );\n\n\t\t\tconst insertionPoint = getBlockInsertionPoint();\n\t\t\tconst order = getBlockOrder( insertionPoint.rootClientId );\n\n\t\t\treturn {\n\t\t\t\tisMultiSelecting: _isMultiSelecting(),\n\t\t\t\tisInserterVisible: isBlockInsertionPointVisible(),\n\t\t\t\tselectedClientId: order[ insertionPoint.index ],\n\t\t\t};\n\t\t},\n\t\t[]\n\t);\n\n\tfunction onMouseMove( event ) {\n\t\tif (\n\t\t\t! event.target.classList.contains(\n\t\t\t\t'block-editor-block-list__layout'\n\t\t\t)\n\t\t) {\n\t\t\tif ( isInserterShown ) {\n\t\t\t\tsetIsInserterShown( false );\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tconst rect = event.target.getBoundingClientRect();\n\t\tconst offset = event.clientY - rect.top;\n\t\tconst element = Array.from( event.target.children ).find(\n\t\t\t( blockEl ) => {\n\t\t\t\treturn blockEl.offsetTop > offset;\n\t\t\t}\n\t\t);\n\n\t\tif ( ! element ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst clientId = element.id.slice( 'block-'.length );\n\n\t\tif ( ! clientId ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst elementRect = element.getBoundingClientRect();\n\n\t\tif (\n\t\t\tevent.clientX > elementRect.right ||\n\t\t\tevent.clientX < elementRect.left\n\t\t) {\n\t\t\tif ( isInserterShown ) {\n\t\t\t\tsetIsInserterShown( false );\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tsetIsInserterShown( true );\n\t\tsetInserterClientId( clientId );\n\t}\n\n\tconst isVisible = isInserterShown || isInserterForced || isInserterVisible;\n\n\treturn (\n\t\t<>\n\t\t\t{ ! isMultiSelecting && isVisible && (\n\t\t\t\t<InsertionPointPopover\n\t\t\t\t\tclientId={\n\t\t\t\t\t\tisInserterVisible ? selectedClientId : inserterClientId\n\t\t\t\t\t}\n\t\t\t\t\tisInserterShown={ isInserterShown }\n\t\t\t\t\tisInserterForced={ isInserterForced }\n\t\t\t\t\tsetIsInserterForced={ setIsInserterForced }\n\t\t\t\t\tcontainerRef={ containerRef }\n\t\t\t\t\tshowInsertionPoint={ isInserterVisible }\n\t\t\t\t/>\n\t\t\t) }\n\t\t\t<div\n\t\t\t\tonMouseMove={\n\t\t\t\t\t! isInserterForced && ! isMultiSelecting\n\t\t\t\t\t\t? onMouseMove\n\t\t\t\t\t\t: undefined\n\t\t\t\t}\n\t\t\t>\n\t\t\t\t{ children }\n\t\t\t</div>\n\t\t</>\n\t);\n}\n"]}