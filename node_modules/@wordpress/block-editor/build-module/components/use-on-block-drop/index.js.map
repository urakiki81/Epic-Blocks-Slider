{"version":3,"sources":["@wordpress/block-editor/src/components/use-on-block-drop/index.js"],"names":["findTransform","getBlockTransforms","pasteHandler","useDispatch","useSelect","parseDropEvent","event","result","srcRootClientId","srcClientIds","srcIndex","type","dataTransfer","Object","assign","JSON","parse","getData","err","onBlockDrop","targetRootClientId","targetBlockIndex","getBlockIndex","getClientIdsOfDescendants","moveBlocksToPosition","sourceRootClientId","sourceClientIds","dropType","sourceBlockIndex","includes","some","id","isAtSameLevel","draggedBlockCount","length","insertIndex","onFilesDrop","hasUploadPermissions","updateBlockAttributes","insertBlocks","files","transformation","transform","isMatch","blocks","onHTMLDrop","HTML","mode","useOnBlockDrop","select","_getBlockIndex","_getClientIdsOfDescendants","getSettings","mediaUpload","onDrop"],"mappings":"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","sourcesContent":["/**\n * WordPress dependencies\n */\nimport {\n\tfindTransform,\n\tgetBlockTransforms,\n\tpasteHandler,\n} from '@wordpress/blocks';\nimport { useDispatch, useSelect } from '@wordpress/data';\n\n/** @typedef {import('@wordpress/element').WPSyntheticEvent} WPSyntheticEvent */\n\n/**\n * Retrieve the data for a block drop event.\n *\n * @param {WPSyntheticEvent} event The drop event.\n *\n * @return {Object} An object with block drag and drop data.\n */\nexport function parseDropEvent( event ) {\n\tlet result = {\n\t\tsrcRootClientId: null,\n\t\tsrcClientIds: null,\n\t\tsrcIndex: null,\n\t\ttype: null,\n\t};\n\n\tif ( ! event.dataTransfer ) {\n\t\treturn result;\n\t}\n\n\ttry {\n\t\tresult = Object.assign(\n\t\t\tresult,\n\t\t\tJSON.parse( event.dataTransfer.getData( 'text' ) )\n\t\t);\n\t} catch ( err ) {\n\t\treturn result;\n\t}\n\n\treturn result;\n}\n\n/**\n * A function that returns an event handler function for block drop events.\n *\n * @param {string}   targetRootClientId        The root client id where the block(s) will be inserted.\n * @param {number}   targetBlockIndex          The index where the block(s) will be inserted.\n * @param {Function} getBlockIndex             A function that gets the index of a block.\n * @param {Function} getClientIdsOfDescendants A function that gets the client ids of descendant blocks.\n * @param {Function} moveBlocksToPosition      A function that moves blocks.\n *\n * @return {Function} The event handler for a block drop event.\n */\nexport function onBlockDrop(\n\ttargetRootClientId,\n\ttargetBlockIndex,\n\tgetBlockIndex,\n\tgetClientIdsOfDescendants,\n\tmoveBlocksToPosition\n) {\n\treturn ( event ) => {\n\t\tconst {\n\t\t\tsrcRootClientId: sourceRootClientId,\n\t\t\tsrcClientIds: sourceClientIds,\n\t\t\ttype: dropType,\n\t\t} = parseDropEvent( event );\n\n\t\t// If the user isn't dropping a block, return early.\n\t\tif ( dropType !== 'block' ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst sourceBlockIndex = getBlockIndex(\n\t\t\tsourceClientIds[ 0 ],\n\t\t\tsourceRootClientId\n\t\t);\n\n\t\t// If the user is dropping to the same position, return early.\n\t\tif (\n\t\t\tsourceRootClientId === targetRootClientId &&\n\t\t\tsourceBlockIndex === targetBlockIndex\n\t\t) {\n\t\t\treturn;\n\t\t}\n\n\t\t// If the user is attempting to drop a block within its own\n\t\t// nested blocks, return early as this would create infinite\n\t\t// recursion.\n\t\tif (\n\t\t\tsourceClientIds.includes( targetRootClientId ) ||\n\t\t\tgetClientIdsOfDescendants( sourceClientIds ).some(\n\t\t\t\t( id ) => id === targetRootClientId\n\t\t\t)\n\t\t) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst isAtSameLevel = sourceRootClientId === targetRootClientId;\n\t\tconst draggedBlockCount = sourceClientIds.length;\n\n\t\t// If the block is kept at the same level and moved downwards,\n\t\t// subtract to take into account that the blocks being dragged\n\t\t// were removed from the block list above the insertion point.\n\t\tconst insertIndex =\n\t\t\tisAtSameLevel && sourceBlockIndex < targetBlockIndex\n\t\t\t\t? targetBlockIndex - draggedBlockCount\n\t\t\t\t: targetBlockIndex;\n\n\t\tmoveBlocksToPosition(\n\t\t\tsourceClientIds,\n\t\t\tsourceRootClientId,\n\t\t\ttargetRootClientId,\n\t\t\tinsertIndex\n\t\t);\n\t};\n}\n\n/**\n * A function that returns an event handler function for block-related file drop events.\n *\n * @param {string}   targetRootClientId    The root client id where the block(s) will be inserted.\n * @param {number}   targetBlockIndex      The index where the block(s) will be inserted.\n * @param {boolean}  hasUploadPermissions  Whether the user has upload permissions.\n * @param {Function} updateBlockAttributes A function that updates a block's attributes.\n * @param {Function} insertBlocks          A function that inserts blocks.\n *\n * @return {Function} The event handler for a block-related file drop event.\n */\nexport function onFilesDrop(\n\ttargetRootClientId,\n\ttargetBlockIndex,\n\thasUploadPermissions,\n\tupdateBlockAttributes,\n\tinsertBlocks\n) {\n\treturn ( files ) => {\n\t\tif ( ! hasUploadPermissions ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst transformation = findTransform(\n\t\t\tgetBlockTransforms( 'from' ),\n\t\t\t( transform ) =>\n\t\t\t\ttransform.type === 'files' && transform.isMatch( files )\n\t\t);\n\n\t\tif ( transformation ) {\n\t\t\tconst blocks = transformation.transform(\n\t\t\t\tfiles,\n\t\t\t\tupdateBlockAttributes\n\t\t\t);\n\t\t\tinsertBlocks( blocks, targetBlockIndex, targetRootClientId );\n\t\t}\n\t};\n}\n\n/**\n * A function that returns an event handler function for block-related HTML drop events.\n *\n * @param {string}   targetRootClientId The root client id where the block(s) will be inserted.\n * @param {number}   targetBlockIndex   The index where the block(s) will be inserted.\n * @param {Function} insertBlocks       A function that inserts blocks.\n *\n * @return {Function} The event handler for a block-related HTML drop event.\n */\nexport function onHTMLDrop(\n\ttargetRootClientId,\n\ttargetBlockIndex,\n\tinsertBlocks\n) {\n\treturn ( HTML ) => {\n\t\tconst blocks = pasteHandler( { HTML, mode: 'BLOCKS' } );\n\n\t\tif ( blocks.length ) {\n\t\t\tinsertBlocks( blocks, targetBlockIndex, targetRootClientId );\n\t\t}\n\t};\n}\n\n/**\n * A React hook for handling block drop events.\n *\n * @param {string} targetRootClientId The root client id where the block(s) will be inserted.\n * @param {number} targetBlockIndex   The index where the block(s) will be inserted.\n *\n * @return {Object} An object that contains the event handlers `onDrop`, `onFilesDrop` and `onHTMLDrop`.\n */\nexport default function useOnBlockDrop( targetRootClientId, targetBlockIndex ) {\n\tconst {\n\t\tgetBlockIndex,\n\t\tgetClientIdsOfDescendants,\n\t\thasUploadPermissions,\n\t} = useSelect( ( select ) => {\n\t\tconst {\n\t\t\tgetBlockIndex: _getBlockIndex,\n\t\t\tgetClientIdsOfDescendants: _getClientIdsOfDescendants,\n\t\t\tgetSettings,\n\t\t} = select( 'core/block-editor' );\n\n\t\treturn {\n\t\t\tgetBlockIndex: _getBlockIndex,\n\t\t\tgetClientIdsOfDescendants: _getClientIdsOfDescendants,\n\t\t\thasUploadPermissions: getSettings().mediaUpload,\n\t\t};\n\t}, [] );\n\n\tconst {\n\t\tinsertBlocks,\n\t\tmoveBlocksToPosition,\n\t\tupdateBlockAttributes,\n\t} = useDispatch( 'core/block-editor' );\n\n\treturn {\n\t\tonDrop: onBlockDrop(\n\t\t\ttargetRootClientId,\n\t\t\ttargetBlockIndex,\n\t\t\tgetBlockIndex,\n\t\t\tgetClientIdsOfDescendants,\n\t\t\tmoveBlocksToPosition\n\t\t),\n\t\tonFilesDrop: onFilesDrop(\n\t\t\ttargetRootClientId,\n\t\t\ttargetBlockIndex,\n\t\t\thasUploadPermissions,\n\t\t\tupdateBlockAttributes,\n\t\t\tinsertBlocks\n\t\t),\n\t\tonHTMLDrop: onHTMLDrop(\n\t\t\ttargetRootClientId,\n\t\t\ttargetBlockIndex,\n\t\t\tinsertBlocks\n\t\t),\n\t};\n}\n"]}