{"version":3,"sources":["@wordpress/block-library/src/legacy-widget/edit/index.js"],"names":["LegacyWidgetEdit","arguments","state","hasEditForm","isPreview","switchToEdit","bind","switchToPreview","changeWidget","props","attributes","availableLegacyWidgets","hasPermissionsToManageWidgets","isSelected","prerenderedEditForm","setAttributes","setWidgetId","widgetId","widgetClass","widgetObject","newWidget","isReferenceWidget","idBase","id_base","instance","undefined","inspectorControls","name","description","renderWidgetPreview","isHidden","update","number","formData","newInstance","newHasEditForm","setState","id","Component","select","clientId","getWidgetIdForClientId","widget","getWidget","editorSettings","getSettings","rendered_form","dispatch","setWidgetIdForClientId"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { get, omit } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { Component } from '@wordpress/element';\nimport { Button, PanelBody, ToolbarGroup } from '@wordpress/components';\nimport { __ } from '@wordpress/i18n';\nimport { withDispatch, withSelect } from '@wordpress/data';\nimport { BlockControls, InspectorControls } from '@wordpress/block-editor';\nimport ServerSideRender from '@wordpress/server-side-render';\nimport { update } from '@wordpress/icons';\n\n/**\n * Internal dependencies\n */\nimport LegacyWidgetEditHandler from './handler';\nimport LegacyWidgetPlaceholder from './placeholder';\n\nclass LegacyWidgetEdit extends Component {\n\tconstructor() {\n\t\tsuper( ...arguments );\n\t\tthis.state = {\n\t\t\thasEditForm: true,\n\t\t\tisPreview: false,\n\t\t};\n\t\tthis.switchToEdit = this.switchToEdit.bind( this );\n\t\tthis.switchToPreview = this.switchToPreview.bind( this );\n\t\tthis.changeWidget = this.changeWidget.bind( this );\n\t}\n\n\trender() {\n\t\tconst {\n\t\t\tattributes,\n\t\t\tavailableLegacyWidgets,\n\t\t\thasPermissionsToManageWidgets,\n\t\t\tisSelected,\n\t\t\tprerenderedEditForm,\n\t\t\tsetAttributes,\n\t\t\tsetWidgetId,\n\t\t\twidgetId,\n\t\t} = this.props;\n\t\tconst { isPreview, hasEditForm } = this.state;\n\t\tconst { widgetClass } = attributes;\n\t\tconst widgetObject =\n\t\t\t( widgetId && availableLegacyWidgets[ widgetId ] ) ||\n\t\t\t( widgetClass && availableLegacyWidgets[ widgetClass ] );\n\n\t\tif ( ! widgetId && ! widgetClass ) {\n\t\t\treturn (\n\t\t\t\t<LegacyWidgetPlaceholder\n\t\t\t\t\tavailableLegacyWidgets={ availableLegacyWidgets }\n\t\t\t\t\thasPermissionsToManageWidgets={\n\t\t\t\t\t\thasPermissionsToManageWidgets\n\t\t\t\t\t}\n\t\t\t\t\tonChangeWidget={ ( newWidget ) => {\n\t\t\t\t\t\tconst {\n\t\t\t\t\t\t\tisReferenceWidget,\n\t\t\t\t\t\t\tid_base: idBase,\n\t\t\t\t\t\t} = availableLegacyWidgets[ newWidget ];\n\t\t\t\t\t\tif ( isReferenceWidget ) {\n\t\t\t\t\t\t\tsetWidgetId( newWidget );\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsetAttributes( {\n\t\t\t\t\t\t\tinstance: {},\n\t\t\t\t\t\t\tidBase,\n\t\t\t\t\t\t\twidgetClass: isReferenceWidget\n\t\t\t\t\t\t\t\t? undefined\n\t\t\t\t\t\t\t\t: newWidget,\n\t\t\t\t\t\t} );\n\t\t\t\t\t} }\n\t\t\t\t/>\n\t\t\t);\n\t\t}\n\n\t\tconst inspectorControls = widgetObject ? (\n\t\t\t<InspectorControls>\n\t\t\t\t<PanelBody title={ widgetObject.name }>\n\t\t\t\t\t{ widgetObject.description }\n\t\t\t\t</PanelBody>\n\t\t\t</InspectorControls>\n\t\t) : null;\n\t\tif ( ! hasPermissionsToManageWidgets ) {\n\t\t\treturn (\n\t\t\t\t<>\n\t\t\t\t\t{ inspectorControls }\n\t\t\t\t\t{ this.renderWidgetPreview() }\n\t\t\t\t</>\n\t\t\t);\n\t\t}\n\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<BlockControls>\n\t\t\t\t\t<ToolbarGroup>\n\t\t\t\t\t\t{ widgetObject && ! widgetObject.isHidden && (\n\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\tonClick={ this.changeWidget }\n\t\t\t\t\t\t\t\tlabel={ __( 'Change widget' ) }\n\t\t\t\t\t\t\t\ticon={ update }\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t) }\n\t\t\t\t\t\t{ hasEditForm && (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\t\tclassName=\"components-tab-button\"\n\t\t\t\t\t\t\t\t\tisPressed={ ! isPreview }\n\t\t\t\t\t\t\t\t\tonClick={ this.switchToEdit }\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<span>{ __( 'Edit' ) }</span>\n\t\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\t\tclassName=\"components-tab-button\"\n\t\t\t\t\t\t\t\t\tisPressed={ isPreview }\n\t\t\t\t\t\t\t\t\tonClick={ this.switchToPreview }\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<span>{ __( 'Preview' ) }</span>\n\t\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t) }\n\t\t\t\t\t</ToolbarGroup>\n\t\t\t\t</BlockControls>\n\t\t\t\t{ inspectorControls }\n\t\t\t\t{ hasEditForm && (\n\t\t\t\t\t<LegacyWidgetEditHandler\n\t\t\t\t\t\tisSelected={ isSelected }\n\t\t\t\t\t\tisVisible={ ! isPreview }\n\t\t\t\t\t\tid={ widgetId }\n\t\t\t\t\t\tidBase={ attributes.idBase || widgetId }\n\t\t\t\t\t\tnumber={ attributes.number }\n\t\t\t\t\t\tprerenderedEditForm={ prerenderedEditForm }\n\t\t\t\t\t\twidgetName={ get( widgetObject, [ 'name' ] ) }\n\t\t\t\t\t\twidgetClass={ attributes.widgetClass }\n\t\t\t\t\t\tinstance={ attributes.instance }\n\t\t\t\t\t\tonFormMount={ ( formData ) => {\n\t\t\t\t\t\t\t// Function-based widgets don't come with an object of settings, only\n\t\t\t\t\t\t\t// with a pre-rendered HTML form. Extracting settings from that HTML\n\t\t\t\t\t\t\t// before this stage is not trivial (think embedded <script>). An alternative\n\t\t\t\t\t\t\t// proposed here serializes the form back into widget settings immediately after\n\t\t\t\t\t\t\t// it's mounted.\n\t\t\t\t\t\t\tif ( ! attributes.widgetClass ) {\n\t\t\t\t\t\t\t\tthis.props.setAttributes( {\n\t\t\t\t\t\t\t\t\tinstance: formData,\n\t\t\t\t\t\t\t\t} );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} }\n\t\t\t\t\t\tonInstanceChange={ ( newInstance, newHasEditForm ) => {\n\t\t\t\t\t\t\tif ( newInstance ) {\n\t\t\t\t\t\t\t\tthis.props.setAttributes( {\n\t\t\t\t\t\t\t\t\tinstance: newInstance,\n\t\t\t\t\t\t\t\t} );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( newHasEditForm !== this.hasEditForm ) {\n\t\t\t\t\t\t\t\tthis.setState( {\n\t\t\t\t\t\t\t\t\thasEditForm: newHasEditForm,\n\t\t\t\t\t\t\t\t} );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} }\n\t\t\t\t\t/>\n\t\t\t\t) }\n\t\t\t\t{ ( isPreview || ! hasEditForm ) && this.renderWidgetPreview() }\n\t\t\t</>\n\t\t);\n\t}\n\n\tchangeWidget() {\n\t\tthis.switchToEdit();\n\t\tthis.props.setAttributes( {\n\t\t\tinstance: {},\n\t\t\tid: undefined,\n\t\t\twidgetClass: undefined,\n\t\t} );\n\t\tthis.setState( {\n\t\t\thasEditForm: true,\n\t\t} );\n\t}\n\n\tswitchToEdit() {\n\t\tthis.setState( { isPreview: false } );\n\t}\n\n\tswitchToPreview() {\n\t\tthis.setState( { isPreview: true } );\n\t}\n\n\trenderWidgetPreview() {\n\t\tconst { widgetId, attributes } = this.props;\n\t\treturn (\n\t\t\t<ServerSideRender\n\t\t\t\tclassName=\"wp-block-legacy-widget__preview\"\n\t\t\t\tblock=\"core/legacy-widget\"\n\t\t\t\tattributes={ {\n\t\t\t\t\twidgetId,\n\t\t\t\t\t...omit( attributes, 'id' ),\n\t\t\t\t} }\n\t\t\t/>\n\t\t);\n\t}\n}\n\nexport default withSelect( ( select, { clientId } ) => {\n\tconst widgetId = select( 'core/edit-widgets' ).getWidgetIdForClientId(\n\t\tclientId\n\t);\n\tconst widget = select( 'core/edit-widgets' ).getWidget( widgetId );\n\tconst editorSettings = select( 'core/block-editor' ).getSettings();\n\tconst {\n\t\tavailableLegacyWidgets,\n\t\thasPermissionsToManageWidgets,\n\t} = editorSettings;\n\treturn {\n\t\thasPermissionsToManageWidgets,\n\t\tavailableLegacyWidgets,\n\t\twidgetId,\n\t\tprerenderedEditForm: widget ? widget.rendered_form : '',\n\t};\n} )(\n\twithDispatch( ( dispatch, { clientId } ) => {\n\t\treturn {\n\t\t\tsetWidgetId( id ) {\n\t\t\t\tdispatch( 'core/edit-widgets' ).setWidgetIdForClientId(\n\t\t\t\t\tclientId,\n\t\t\t\t\tid\n\t\t\t\t);\n\t\t\t},\n\t\t};\n\t} )( LegacyWidgetEdit )\n);\n"]}