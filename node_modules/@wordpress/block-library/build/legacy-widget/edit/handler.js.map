{"version":3,"sources":["@wordpress/block-library/src/legacy-widget/edit/handler.js"],"names":["window","XMLHttpRequest","FormData","LegacyWidgetEditHandler","props","arguments","state","form","prerenderedEditForm","widgetNonce","instanceUpdating","onInstanceChange","bind","requestWidgetForm","isStillMounted","trySetNonce","undefined","response","prevProps","widgetClass","instance","instanceId","id","number","idBase","isSelected","widgetName","widgetTitle","title","display","isVisible","ref","widgetEditDomManagerRef","onFormMount","element","document","getElementById","value","instanceChanges","updatedInstance","callback","httpRequest","formData","append","open","ajaxurl","addEventListener","responseText","setState","send","path","encodeURIComponent","data","method","then","Component"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { get } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { Component } from '@wordpress/element';\nimport apiFetch from '@wordpress/api-fetch';\nimport { withInstanceId } from '@wordpress/compose';\n\n/**\n * Internal dependencies\n */\nimport LegacyWidgetEditDomManager from './dom-manager';\n\nconst { XMLHttpRequest, FormData } = window;\n\nclass LegacyWidgetEditHandler extends Component {\n\tconstructor( props ) {\n\t\tsuper( ...arguments );\n\t\tthis.state = {\n\t\t\tform: props.prerenderedEditForm,\n\t\t};\n\t\tthis.widgetNonce = null;\n\t\tthis.instanceUpdating = null;\n\t\tthis.onInstanceChange = this.onInstanceChange.bind( this );\n\t\tthis.requestWidgetForm = this.requestWidgetForm.bind( this );\n\t}\n\n\tcomponentDidMount() {\n\t\tthis.isStillMounted = true;\n\t\tthis.trySetNonce();\n\t\tif ( ! this.props.prerenderedEditForm ) {\n\t\t\tthis.requestWidgetForm( undefined, ( response ) => {\n\t\t\t\tthis.props.onInstanceChange( null, !! response.form );\n\t\t\t} );\n\t\t}\n\t}\n\n\tcomponentDidUpdate( prevProps ) {\n\t\tif ( ! this.widgetNonce ) {\n\t\t\tthis.trySetNonce();\n\t\t}\n\t\tif ( prevProps.widgetClass !== this.props.widgetClass ) {\n\t\t\tthis.requestWidgetForm( undefined, ( response ) => {\n\t\t\t\tthis.props.onInstanceChange( null, !! response.form );\n\t\t\t} );\n\t\t}\n\t\tif ( this.instanceUpdating === this.props.instance ) {\n\t\t\tthis.instanceUpdating = null;\n\t\t}\n\t}\n\n\tcomponentWillUnmount() {\n\t\tthis.isStillMounted = false;\n\t}\n\n\trender() {\n\t\tconst {\n\t\t\tinstanceId,\n\t\t\tid,\n\t\t\tnumber,\n\t\t\tidBase,\n\t\t\tinstance,\n\t\t\tisSelected,\n\t\t\twidgetName,\n\t\t} = this.props;\n\t\tconst { form } = this.state;\n\n\t\tif ( ! form ) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst widgetTitle = get( instance, [ 'title' ] );\n\t\tlet title = null;\n\t\tif ( isSelected ) {\n\t\t\tif ( widgetTitle && widgetName ) {\n\t\t\t\ttitle = `${ widgetName }: ${ widgetTitle }`;\n\t\t\t} else if ( ! widgetTitle && widgetName ) {\n\t\t\t\ttitle = widgetName;\n\t\t\t} else if ( widgetTitle && ! widgetName ) {\n\t\t\t\ttitle = widgetTitle;\n\t\t\t}\n\t\t}\n\t\treturn (\n\t\t\t<>\n\t\t\t\t{ title && (\n\t\t\t\t\t<div className=\"wp-block-legacy-widget__edit-widget-title\">\n\t\t\t\t\t\t{ title }\n\t\t\t\t\t</div>\n\t\t\t\t) }\n\t\t\t\t<div\n\t\t\t\t\tclassName=\"wp-block-legacy-widget__edit-container\"\n\t\t\t\t\t// Display none is used because when we switch from edit to preview,\n\t\t\t\t\t// we don't want to unmount the component.\n\t\t\t\t\t// Otherwise when we went back to edit we wound need to trigger\n\t\t\t\t\t// all widgets events again and some scripts may not deal well with this.\n\t\t\t\t\tstyle={ {\n\t\t\t\t\t\tdisplay: this.props.isVisible ? 'block' : 'none',\n\t\t\t\t\t} }\n\t\t\t\t>\n\t\t\t\t\t<LegacyWidgetEditDomManager\n\t\t\t\t\t\tisReferenceWidget={ !! id }\n\t\t\t\t\t\tref={ ( ref ) => {\n\t\t\t\t\t\t\tthis.widgetEditDomManagerRef = ref;\n\t\t\t\t\t\t} }\n\t\t\t\t\t\tonInstanceChange={ this.onInstanceChange }\n\t\t\t\t\t\tonMount={ this.props.onFormMount }\n\t\t\t\t\t\tnumber={ number ? number : instanceId * -1 }\n\t\t\t\t\t\tid={ id }\n\t\t\t\t\t\tidBase={ idBase }\n\t\t\t\t\t\tform={ form }\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</>\n\t\t);\n\t}\n\n\ttrySetNonce() {\n\t\tconst element = document.getElementById( '_wpnonce_widgets' );\n\t\tif ( element && element.value ) {\n\t\t\tthis.widgetNonce = element.value;\n\t\t}\n\t}\n\n\tonInstanceChange( instanceChanges ) {\n\t\tthis.props.onInstanceChange( instanceChanges, true );\n\t}\n\n\trequestWidgetForm( updatedInstance, callback ) {\n\t\tconst { id, idBase, instance, widgetClass } = this.props;\n\t\tconst { isStillMounted } = this;\n\t\tif ( ! id && ! widgetClass ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// If we are in the presence of a reference widget, do a save ajax request\n\t\t// with empty changes so we retrieve the widget edit form.\n\t\tif ( id ) {\n\t\t\tconst httpRequest = new XMLHttpRequest();\n\t\t\tconst formData = new FormData();\n\t\t\tformData.append( 'action', 'save-widget' );\n\t\t\tformData.append( 'id_base', idBase );\n\t\t\tformData.append( 'widget-id', id );\n\t\t\tformData.append( 'widget-width', '250' );\n\t\t\tformData.append( 'widget-height', '200' );\n\t\t\tformData.append( 'savewidgets', this.widgetNonce );\n\t\t\thttpRequest.open( 'POST', window.ajaxurl );\n\t\t\thttpRequest.addEventListener( 'load', () => {\n\t\t\t\tif ( isStillMounted ) {\n\t\t\t\t\tconst form = httpRequest.responseText;\n\t\t\t\t\tthis.setState( { form } );\n\t\t\t\t\tif ( callback ) {\n\t\t\t\t\t\tcallback( { form } );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} );\n\t\t\thttpRequest.send( formData );\n\t\t\treturn;\n\t\t}\n\n\t\tif ( widgetClass ) {\n\t\t\tapiFetch( {\n\t\t\t\tpath: `/__experimental/widget-utils/form/${ encodeURIComponent(\n\t\t\t\t\twidgetClass\n\t\t\t\t) }/`,\n\t\t\t\tdata: {\n\t\t\t\t\tinstance: {\n\t\t\t\t\t\t...instance,\n\t\t\t\t\t\t...updatedInstance,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tmethod: 'POST',\n\t\t\t} ).then( ( response ) => {\n\t\t\t\tif ( isStillMounted ) {\n\t\t\t\t\tthis.setState( {\n\t\t\t\t\t\tform: response.form,\n\t\t\t\t\t} );\n\t\t\t\t\tif ( callback ) {\n\t\t\t\t\t\tcallback( response );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} );\n\t\t}\n\t}\n}\n\nexport default withInstanceId( LegacyWidgetEditHandler );\n"]}