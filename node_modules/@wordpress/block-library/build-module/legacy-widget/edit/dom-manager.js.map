{"version":3,"sources":["@wordpress/block-library/src/legacy-widget/edit/dom-manager.js"],"names":["includes","Component","createRef","LegacyWidgetEditDomManager","arguments","containerRef","formRef","widgetContentRef","idBaseInputRef","widgetNumberInputRef","triggerWidgetEvent","bind","props","onMount","getFormData","nextProps","shouldTriggerWidgetUpdateEvent","idBase","current","value","number","form","widgetContent","innerHTML","id","isReferenceWidget","onInstanceChange","__html","event","window","jQuery","document","trigger","formData","FormData","updatedInstance","keys","rawKey","matches","match","keyParsed","getAll","length"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { includes } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { Component, createRef } from '@wordpress/element';\n\nclass LegacyWidgetEditDomManager extends Component {\n\tconstructor() {\n\t\tsuper( ...arguments );\n\n\t\tthis.containerRef = createRef();\n\t\tthis.formRef = createRef();\n\t\tthis.widgetContentRef = createRef();\n\t\tthis.idBaseInputRef = createRef();\n\t\tthis.widgetNumberInputRef = createRef();\n\t\tthis.triggerWidgetEvent = this.triggerWidgetEvent.bind( this );\n\t}\n\n\tcomponentDidMount() {\n\t\tthis.triggerWidgetEvent( 'widget-added' );\n\t\tif ( this.props.onMount ) {\n\t\t\tthis.props.onMount( this.getFormData() );\n\t\t}\n\t}\n\n\tshouldComponentUpdate( nextProps ) {\n\t\tlet shouldTriggerWidgetUpdateEvent = false;\n\t\t// We can not leverage react render otherwise we would destroy dom changes applied by the plugins.\n\t\t// We manually update the required dom node replicating what the widget screen and the customizer do.\n\t\tif (\n\t\t\tnextProps.idBase !== this.props.idBase &&\n\t\t\tthis.idBaseInputRef.current\n\t\t) {\n\t\t\tthis.idBaseInputRef.current.value = nextProps.idBase;\n\t\t\tshouldTriggerWidgetUpdateEvent = true;\n\t\t}\n\t\tif (\n\t\t\tnextProps.number !== this.props.number &&\n\t\t\tthis.widgetNumberInputRef.current\n\t\t) {\n\t\t\tthis.widgetNumberInputRef.current.value = nextProps.number;\n\t\t}\n\t\tif (\n\t\t\tnextProps.form !== this.props.form &&\n\t\t\tthis.widgetContentRef.current\n\t\t) {\n\t\t\tconst widgetContent = this.widgetContentRef.current;\n\t\t\twidgetContent.innerHTML = nextProps.form;\n\t\t\tshouldTriggerWidgetUpdateEvent = true;\n\t\t}\n\t\tif ( shouldTriggerWidgetUpdateEvent ) {\n\t\t\tthis.triggerWidgetEvent( 'widget-updated' );\n\t\t}\n\t\treturn false;\n\t}\n\n\trender() {\n\t\tconst { id, idBase, number, form, isReferenceWidget } = this.props;\n\t\treturn (\n\t\t\t<div className=\"widget open\" ref={ this.containerRef }>\n\t\t\t\t<div className=\"widget-inside\">\n\t\t\t\t\t<form\n\t\t\t\t\t\tclassName=\"form\"\n\t\t\t\t\t\tref={ this.formRef }\n\t\t\t\t\t\tmethod=\"post\"\n\t\t\t\t\t\tonBlur={ () =>\n\t\t\t\t\t\t\tthis.props.onInstanceChange( this.getFormData() )\n\t\t\t\t\t\t}\n\t\t\t\t\t>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tref={ this.widgetContentRef }\n\t\t\t\t\t\t\tclassName=\"widget-content\"\n\t\t\t\t\t\t\tdangerouslySetInnerHTML={ { __html: form } }\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{ isReferenceWidget && (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"hidden\"\n\t\t\t\t\t\t\t\t\tname=\"widget-id\"\n\t\t\t\t\t\t\t\t\tclassName=\"widget-id\"\n\t\t\t\t\t\t\t\t\tvalue={ id }\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tref={ this.idBaseInputRef }\n\t\t\t\t\t\t\t\t\ttype=\"hidden\"\n\t\t\t\t\t\t\t\t\tname=\"id_base\"\n\t\t\t\t\t\t\t\t\tclassName=\"id_base\"\n\t\t\t\t\t\t\t\t\tvalue={ idBase }\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tref={ this.widgetNumberInputRef }\n\t\t\t\t\t\t\t\t\ttype=\"hidden\"\n\t\t\t\t\t\t\t\t\tname=\"widget_number\"\n\t\t\t\t\t\t\t\t\tclassName=\"widget_number\"\n\t\t\t\t\t\t\t\t\tvalue={ number }\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"hidden\"\n\t\t\t\t\t\t\t\t\tname=\"multi_number\"\n\t\t\t\t\t\t\t\t\tclassName=\"multi_number\"\n\t\t\t\t\t\t\t\t\tvalue=\"\"\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"hidden\"\n\t\t\t\t\t\t\t\t\tname=\"add_new\"\n\t\t\t\t\t\t\t\t\tclassName=\"add_new\"\n\t\t\t\t\t\t\t\t\tvalue=\"\"\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t) }\n\t\t\t\t\t</form>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t);\n\t}\n\n\ttriggerWidgetEvent( event ) {\n\t\twindow\n\t\t\t.jQuery( window.document )\n\t\t\t.trigger( event, [ window.jQuery( this.containerRef.current ) ] );\n\t}\n\n\tgetFormData() {\n\t\tif ( this.formRef.current ) {\n\t\t\tconst form = this.formRef.current;\n\t\t\tconst formData = new window.FormData( form );\n\t\t\tconst updatedInstance = {};\n\t\t\tfor ( const rawKey of formData.keys() ) {\n\t\t\t\t// This fields are added to the form because the widget JavaScript code may use this values.\n\t\t\t\t// They are not relevant for the update mechanism.\n\t\t\t\tif (\n\t\t\t\t\tincludes(\n\t\t\t\t\t\t[\n\t\t\t\t\t\t\t'widget-id',\n\t\t\t\t\t\t\t'id_base',\n\t\t\t\t\t\t\t'widget_number',\n\t\t\t\t\t\t\t'multi_number',\n\t\t\t\t\t\t\t'add_new',\n\t\t\t\t\t\t],\n\t\t\t\t\t\trawKey\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst matches = rawKey.match( /[^\\[]*\\[[-\\d]*\\]\\[([^\\]]*)\\]/ );\n\t\t\t\tconst keyParsed =\n\t\t\t\t\tmatches && matches[ 1 ] ? matches[ 1 ] : rawKey;\n\t\t\t\tconst value = formData.getAll( rawKey );\n\t\t\t\tif ( value.length > 1 ) {\n\t\t\t\t\tupdatedInstance[ keyParsed ] = value;\n\t\t\t\t} else {\n\t\t\t\t\tupdatedInstance[ keyParsed ] = value[ 0 ];\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn updatedInstance;\n\t\t}\n\t}\n}\n\nexport default LegacyWidgetEditDomManager;\n"]}